<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CifVis: Crystal Structure Visualization</title>
  <style>
    
 </style>
  <script type="module" crossorigin src="/cifvis_presentation/assets/main-BO-ykT0b.js"></script>
  <link rel="modulepreload" crossorigin href="/cifvis_presentation/assets/reveal-OpwdKu1w.js">
  <link rel="modulepreload" crossorigin href="/cifvis_presentation/assets/cifvis-D7itqmy8.js">
  <link rel="modulepreload" crossorigin href="/cifvis_presentation/assets/d3-Dfta__CX.js">
  <link rel="stylesheet" crossorigin href="/cifvis_presentation/assets/main-gKN7VfUX.css">
</head>
<body>
  <div class="reveal">
    <div class="logo">
      <img src="/cifvis_presentation/assets/DurhamUniversity-DM9BeCWl.svg">
    </div>
    <div class="slides">
      <!-- Title Slide -->
      <section>
        <h1>CifVis</h1>
        <h2>Crystal Structure Visualisation in JavaScript</h2>
        <p style="font-size: 2em; text-align: center !important;">
          Paul Niklas Ruth
        </p>
        <p style="font-size: 2em; text-align: center !important;">
          Advanced Research Computing
        </p>
        <p style="font-size: 2em; text-align: center !important;">
          Durham University
        </p>
      </section>

      <section>
        <h1>Part 1: The result</h1>
      </section>

      <!-- What is CifVis Slide -->
      <section>
        <h2>Why does CifVis exist?</h2>
        <div style="font-size: 1.3em; text-align: left;">
          <ul>
            <li>For another project I needed an ORTEP display of structures as a web component</li>
            <ul style="font-size: 0.8em;">
              <li>Work from cif files</li>
              <li>Display thermal ellipsoids</li>
            </ul>
            <li class="fragment">I could not find an existing solution. So, I build one myself</li>
            <li class="fragment">How hard can it be to make this useful to others?</li>
            <ul class="fragment" style="font-size: 0.8em;">
              <li>Have all the CIF processing done locally on the computer accessing the structure</li>
              <li>Validate against a CIF database</li>
            </ul>
          </ul>
        </div>
      </section>

      <section>
        <h2>Add structures with minimal HTML</h2>
        <div class="columns">
          <div class="column">
            <pre style="height: 100%;"><code class="html">&lt;script 
  type="module" 
  src="https://niolon.github.io/cifvis/dist/cifvis.alldeps.js"&gt;
&lt;/script&gt;

&lt;cifview-widget 
  src="example.cif"
  caption="Crystal Structure Caption"
  hydrogen-mode="constant"&gt;
&lt;/cifview-widget&gt;</code></pre>
          </div>
          <div class="column">
            <div class="cifvis-container" id="cifvis-demo">
              <cifview-widget
                src="./src/assets/xylitol.cif"
                caption="Crystal Structure Caption"
                hydrogen-mode="constant">
              </cifview-widget>
            </div>
          </div>
        </div>
      </section>

      <!-- Interaction Slide -->
      <section>
        <h2>Interaction with the display</h2>
        <div class="columns">
          <div class="column">
            <h3>Mouse interaction</h3>
            <p>
              Rotate: left drag<br>
              Select: left click<br>
              Drag: right drag<br>
              Zoom: Mouse wheel
            </p>

            <h3>Touch interaction</h3>
            <p>
              Rotate: one-finger drag<br>
              Select: one-finger touch<br>
              Drag: two-finger drag<br>
              Zoom: two-finger pinch
            </p>
          </div>
          <div class="column">
            <div class="cifvis-container" id="cifvis-interaction">
              <cifview-widget
                src="./src/assets/capsaicin.cif"
                caption="Crystal structure of capsaicin <a href='https://doi.org/10.1107/S2053229625001706' target='_blank'>(Lozinšek, 2025)</a>."
                hydrogen-mode="constant">
              </cifview-widget>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2>Buttons are adapted to the structure</h2>
        <div class="cifvis-container" style="padding-left: 10%; padding-right: 10%; width: 80%;">
          <cifview-widget
            src="./src/assets/hani.cif"
            caption="Hydrogen button adapts to hydrogens present <a href='https://doi.org/10.1002/chem.202303762' target='_blank'>(Meurer et al., 2024)</a>."
            hydrogen-mode="constant">
          </cifview-widget>
        </div>
      </section>

      <section>
        <h2>Buttons are adapted to the structure</h2>
        <div class="cifvis-container" style="padding-left: 10%; padding-right: 10%; width: 80%;">
          <cifview-widget
            src="./src/assets/disorder.cif"
            caption="If disorder is present: an additional button will appear <a href='https://doi.org/10.1002/ange.202110456' target='_blank'>(Ding et al., 2021)</a>."
            hydrogen-mode="none">
          </cifview-widget>
        </div>
      </section>

      <section>
        <h2>Buttons are adapted to the structure</h2>
        <div class="cifvis-container" style="padding-left: 10%; padding-right: 10%; width: 80%;">
          <cifview-widget
                src="./src/assets/urea.cif"
                caption="There is also an adaptive button for growing structures if bonds outside structures are present <a href='https://doi.org/10.1107/S0108767304015120' target='_blank'>(Birkedal et al., 2004)</a>."
                hydrogen-mode="constant">
          </cifview-widget>
        </div>
      </section>

      
      <!-- Filtered Atoms Slide -->
      <section>
        <h2>Atoms can be omitted</h2>
        <div class="columns">
          <div class="column">
            No filtered atoms
            <div class="cifvis-container">
              <cifview-widget 
                src="./src/assets/fullerene.cif"
                caption="Complete structure including solvent molecules">
              </cifview-widget>
            </div>
          </div>
          <div class="column">
            <code>filtered-atoms="C200,H200,C201>H218"</code>
            <div class="cifvis-container">
              <cifview-widget 
                src="./src/assets/fullerene.cif"
                caption="Structure with solvent molecules removed"
                filtered-atoms="C200,H200,C201>H218">
              </cifview-widget>
            </div>
          </div>
        </div>
      </section>

      <!-- CIF Display Slide -->
      <section>
        <h2>CifVis displays what is in the CIF file</h2>
        <div class="columns">
          <div class="column">
            <ul>
              <li>Bonds / hydrogen bonds are read from CIF</li>
              <li>Only if all bonds are missing, CifVis will add them</li>
            </ul>
            <div class="button-row">
              <button class="reload" id="btn-load-bonds">Reload with bonds</button>
              <button class="reload" id="btn-load-nobonds">Reload without bonds</button>
            </div>
            <div class="spacer"></div>
            <div class="fragment">
              <ul>
                <li>Rather than trying to interpret inconsistent cif files, an error is displayed</li>
                <ul style="font-size: 0.8em;">
                  <li>atoms are "Uani", but CIF has no U<sub>ij</sub></li>
                  <li>atoms in the bond table do not exist in the atom site table</li>
                </ul>
              </ul>
              <button class="reload" id="btn-load-invalid">Load invalid structure</button>
            </div>
          </div>
          <div class="column">
            <div class="cifvis-container" id="cifvis-loading">
              <cifview-widget
                src="./src/assets/large_bonds.cif"
                caption="Large structure demonstration <a href='https://doi.org/10.1021/acs.nanolett.7b02284' target='_blank'>(Li et al., 2017)</a>."
                id="cifview-loading">
              </cifview-widget>
            </div>
          </div>
        </div>
      </section>

      <!-- Integration Slide -->

      <section>
        <h2>CifVis Library Architecture</h2>
        <div class="columns" style="align-items: center;">
          <div class="column">
            <ul class="architecture-layers">
              <li class="layer">
                <div class="layer-name">CIF</div>
                <div class="layer-desc">Parses the CIF text format into structured data</div>
              </li>
              <li class="layer">
                <div class="layer-name">CrystalStructure</div>
                <div class="layer-desc">Creates a model with atoms, bonds, and unit cell information</div>
              </li>
              <li class="layer">
                <div class="layer-name">ORTEP3DStructure</div>
                <div class="layer-desc">Builds 3D visual representation with Three.js objects</div>
              </li>
              <li class="layer">
                <div class="layer-name">CrystalViewer</div>
                <div class="layer-desc">Provides interactive camera, selection, and display controls</div>
              </li>
            </ul>
          </div>
          <div class="column">
            <div class="architecture-diagram">
              <div class="arch-layer">
                <div class="arch-box cif">
                  <h4>CIF</h4>
                  <div class="arch-details">Block -> Loop</div>
                </div>
              </div>
              <div class="arch-arrow">↓</div>
              <div class="arch-layer">
                <div class="arch-box crystal">
                  <h4>CrystalStructure</h4>
                </div>
              </div>
              <div class="arch-arrow">↓</div>
              <div class="arch-layer">
                <div class="arch-box ortep">
                  <h4>ORTEP3DStructure</h4>
                  <div class="arch-details">getGroup() returns the THREE.js Group</div>
                </div>
              </div>
              <div class="arch-arrow">↓</div>
              <div class="arch-layer">
                <div class="arch-box viewer">
                  <h4>CrystalViewer</h4>
                  <div class="arch-details">Camera, Selection, Modifiers</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2>Testing the robustness against the COD</h2>
        <div class="fragment" id="cod-bar-plot"></div>
      </section>

      <section>
        <h2>Most failures are attributed to inconsistencies within the files.</h2>
        <div id="cod-bar-plot-structure"></div>
      </section>
      <section>
        <h2>What is currently missing</h2>
        <div style="font-size: 1.5em;">
          <ul>
            <li>Cell packing</li>
            <li>Custom growing</li>
            <li>Displaying Isosurfaces</li>
            <li>Orthographic projection</li>
            <li>Different Bond styles</li>
          </ul>
        </div>
      </section>
      <section>
        <h2>What does CifVis offer</h2>
        <div class="columns">
          <div class="column">
            <p>As a widget</p>
            <ul>
              <li>Easy batteries included display of crystal structure data</li>
              <li>Thermal ellipsoids</li>
              <li>Handling of basic disorder</li>
              <li>Selection and information display for bonds</li>
            </ul>
          </div>
          <div class="column">
            <p>As a JavaScript library</p>
            <ul>
              <li>Object abstraction for CIF (including blocks, loops and esd handling)</li>
              <li>Access to thermal ellipsoid object as three.js group</li>
              <li>CrystalViewer that can be attached to DOM element with a hook for callback on selection</li>
            </ul>

          </div>
        </div>
      </section>
      <section>
        <h2>The library is available on GitHub</h2>
        <div style="font-size: 1.5em;">
          <p style="height: 50px;"></p>
          <p>The code <a href="https://github.com/Niolon/cifvis" target='_blank'>https://github.com/Niolon/cifvis</a></p>
          <p>Example: Online CIF Viewer: <a href="https://niolon.github.io/cifvis" target='_blank'>https://niolon.github.io/cifvis</a></p>
          <p style="height: 50px;"></p>
          <p class="fragment">These slides: <a href="https://niolon.github.io/cifvis_presentation" target='_blank'>https://niolon.github.io/cifvis_presentation</a></p>
        </div>
      </section>

      <section>
        <img src="/cifvis_presentation/assets/ICDM10_ADVERT-B8HbIscr.jpg" style="width: 100%; object-fit: scale-down;">
      </section>

      <section>
        <h2>Thanks to</h2>

        <div class="columns">
          <div class="column">
            <p>Feedback/Help:</p>
            <p>Oleg Dolomanov</p>
            <p>Horst Puschmann</p>
            <p>Florian Kleemiss</p>
            <p>Florian Meurer</p>
            <p>Toby Blundell</p>
          </div>
          <div class="column">
            <p>Advice during Coding:</p>
            <p>Samantha Finnigan</p>

            <p></p>
            <p>Funding:</p>
            <img src="/cifvis_presentation/assets/epsrc-DMkK1Inh.png" style="width: 500px;">
            
          </div>
        </div>
      </section>

      <section>
        <h1>Part 2: Development</h1>
      </section>

      <section>
        <h2>Working with Claude</h2>
        <ul>
          <li>Setting up a dedicated project for development</li>
          <ul style="font-size: 0.8em;">
            <li>Provide a meaningful project instruction</li>
            <li>Upload created files as reference</li>
            <li>Means that the LLM can get information about existing implementation via RAG</li>
          </ul>
          <li>Constant back and forth to have a consistency and a balance between overengineering and "underengineering."</li>
          <ul style="font-size: 0.8em;">
            <li>A large language model only imitates the thinking contained in the text of the training set</li>
            <li>Common issues: Not really reusing components unless prompted; Being caught in a direction once it is in chat text; Sometimes quite wordy code (LLMs can be thought of having a limited amount of information retrieved/processed per token).</li>
            <li>Be careful to delete chats with ideas that have not been implemented</li>
          </ul>
        </ul>
      </section>

      <section>
        <h2>JavaScript dependencies</h2>
        <div class="columns">
          <div class="column">
            <ul>
              <li>Try to limit the production dependencies to what is strictly necessary</li>
              <ul style="font-size: 0.8em;">
                <li>Cif parsing: no external depencencies</li>
                <li>Crystal Structure abstraction: Math.js for linear algebra</li>
                <li>Ortep3D and CifViewer: Three.js for the 3D display</li>
              </ul>
              <li>Less restricted for development</li>
              <ul style="font-size: 0.8em;">
                <li>Build: Vite</li>
                <li>Testing: Vitest</li>
                <li>Linting: ESLint</li>
                <li>Pre-commit hooks: Husky</li>
              </ul>
            </ul>
          </div>
          <div class="column">
            <div class="architecture-diagram">
              <div class="arch-layer">
                <div class="arch-box cif">
                  <h4>CIF</h4>
                  <div class="arch-details">Block -> Loop</div>
                </div>
              </div>
              <div class="arch-arrow">↓</div>
              <div class="arch-layer">
                <div class="arch-box crystal">
                  <h4>CrystalStructure</h4>
                </div>
              </div>
              <div class="arch-arrow">↓</div>
              <div class="arch-layer">
                <div class="arch-box ortep">
                  <h4>ORTEP3DStructure</h4>
                  <div class="arch-details">getGroup() returns the THREE.js Group</div>
                </div>
              </div>
              <div class="arch-arrow">↓</div>
              <div class="arch-layer">
                <div class="arch-box viewer">
                  <h4>CrystalViewer</h4>
                  <div class="arch-details">Camera, Selection, Modifiers</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
      </section>

      <section>
        <h2>Problem specific Three.js optimisations</h2>
        <div class="columns">
          <div class="column">
            <ul>
              <li>Three.js benefits greatly from reusing objects with different deformations</li>
              <ul style="font-size: 0.8em;">
                <li>There is only one base bond object</li>
                <li>There is one base atom object per atom colour</li>
                <li>There is one base atom ring object per ring colour</li>
              </ul>
              <li>Only redraw on interaction</li>
              <ul style="font-size: 0.8em;">
                <li>By default, Three.js is also meant for animation. Limiting redrawing the objects to active user interactions enables the presence of a larger number of active widgets.</li>
              </ul>
            </ul>
            
          </div>
          <div class="column">
            <div class="cifvis-container" id="cifvis-demo">
              <cifview-widget
                src="./src/assets/xylitol.cif"
                caption="Crystal Structure Caption"
                hydrogen-mode="constant">
              </cifview-widget>
            </div>    
          </div>
        </div>
      </section>

      <section>
        <h2>Development with Vite</h2>
        <ul>
          <li>Can package up websites and JavaScript scripts for usage and deployment</li>
          <li>Cifvis uses three different configs:</li>
          <ul style="font-size: 0.8em;">
            <li>base: build library</li>
            <li>alldeps: build one file including all depencencies</li>
            <li>demo: build demo and tutorial websites</li>
          </ul>
          <li>Supports plugins, used for including default SVG files for icons into library</li>
          <li>Support dev mode, which reloads whenever files in the project are changed (which speeds things up a lot).</li>
        </ul>
      </section>

      <section>
        <h2>Testing with Vitest: Syntax</h2>
        <p>Test files are located next to the library file with the ending: <code>*.test.js</code></p>
        <div class="columns">
          <div class="column">
        <pre style="height: 100%;"><code class="JS">describe('CIF Parser', () => {
  describe('CIF class', () => {
      test('parses multiple data blocks', () => {
          const cif = new CIF(`data_block1
_cell_length_a 5.4309(5)

data_block2
_cell_length_a 3.2468(3)`);      
          const blocks = cif.getAllBlocks();
          expect(blocks).toHaveLength(2);
          expect(blocks[0].dataBlockName).toBe('block1');
          expect(blocks[1].dataBlockName).toBe('block2');
      });
  });
});</code></pre>
      </div>
      <div class="column fragment">
        <pre style="height: 100%;">
          <code class="JS">/**
* @vi-environment jsdom
*/

test('loads structure from URL', async () => {
  const widget = document.createElement('cifview-widget');
  widget.setAttribute('src', 'test.cif');
  document.body.appendChild(widget);

  // We need to wait longer for the fetch and loadCIF to complete
  await new Promise(resolve => setTimeout(resolve, 20));

  expect(mockFetch).toHaveBeenCalledWith('test.cif');
  expect(mockCrystalViewer.loadCIF).toHaveBeenCalled();
});</code>
        </pre>

      </div>
        </div>
      </section>
      <section>
        <h2>Vitest: Output</h2>
        <div class="columns">
          <div class="column" style="text-align: left;">
            <h3>Implement testing in CLI</h3>
            <p>Just use a simple script in the <code>package.json</code></p>
            <p><code class="bash">vitest run</code></p>
            <h3>HTML coverage report via command</h3>
            <p><code class="bash">vitest run --coverage</code></p>
            <p>Produces CLI out and a HTML report</p>
          </div>
          <div class="column fragment" style="text-align: left;">
            <h3>Integration with VSCode</h3>
            <p>Integration using Vitest plugin</p>
            <p>Allows for:</p>
            <ul>
              <li>Display of coverage in VSCode</li>
              <li>Easy execution of a subset of tests</li>
              <li>Execution of tests with break points</li>
            </ul>
          </div>
        </div>
      </section>
      <section>
        <h2>Integration tests</h2>
        <ul>
          <li>Integration tests were implemented as separate scripts</li>
          <li>Need to be pointed at a folder with a database of cif files</li>
          <li>With help of LLM also created a bash script to extract cif files that failed unexpectedly</li>
          <li>Sparked another two weeks of bug squashing as lots of edge cases were discovered</li>
        </ul>
      </section>

      <section>
        <h2>Linting with ESLint</h2>
        <ul>
          <li>Enables linting (automatic formatting of the code to a common standart)</li>
          <li>Allows for detailed settings for all the individual items</li>
          <li>Plugin also enables checking whether JSDoc documentation has been done and is consistent</li>
        </ul>
      </section>

      <section>
        <h2>Pre-commit hooks with husky</h2>
        <ul>
          <li>Pre-commit hooks are executed as you commit using git.</li>
          <li>Easy adding of pre-commit hooks via entry to the package.json</li>
          <li>Here ensure that ESLint is executed upon commit.</li>
          <li>Actually the requirement I am least sure about.</li>
        </ul>
      </section>

      <section>
        <h2>Continuous Integration, Delivery and Deployment</h2>
        <p>Two GitHub workflows are triggered upon committing to <code>main</code>:</p>
        <ul>
          <li>Test: Run all tests implemented with vitest and test whether there are issues flagged by ESLint</li>
          <li>Deploy: Subsequently build for all three vite config files and deploy the build libraries and demo website to github pages</li>
        </ul>
      </section>

      <section>
        <h2>Releasing the library</h2>
        <ul>
          <li>The library is manually released onto npm when the version number is increased</li>
          <li>Setup was as easy as following the instructions on npm to set that up</li>
          <li>Also manually put releases onto GitHub</li>
        </ul>
      </section>

      <section>
        <h2>The left-over sharp bits</h2>
        <ul>
          <li>I wanted to have a default CSS style for the widget that is tranferred with the library. However that means all styling using CSS can only be done using the <code>!important</code> flag</li>
          <li>There are some minor functions missing (as mentioned in the original presentation)</li>
          <li>As it is the first solution working nicely on mobile, maybe release as single website app?</li>
        </ul>
      </section>

      <section>
        <h1>Thank you for your kind attention</h1>
        <div style="font-size: 1.8em;">Creation of presentation was done using</div>
        <ul>
          <li>Reveal.js for slides</li>
          <li>D3.js for bar plots</li>
          <li>CifVis obviously</li>
        </ul>
      </section>
    </div>
  </div>

  

  <!-- Scripts -->
</body>
</html>